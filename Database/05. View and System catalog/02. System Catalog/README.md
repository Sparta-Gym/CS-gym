# 2. 시스템 카탈로그

<!--ts-->

- [2. 시스템 카탈로그](#2-시스템-카탈로그)
  - [1. 시스템 카탈로그](#1-시스템-카탈로그)
  - [2. 시스템 카탈로그가 쿼리 프로세싱에 어떻게 활용되는가](#2-시스템-카탈로그가-쿼리-프로세싱에-어떻게-활용되는가)
  - [3. 쿼리 최적화](#3-쿼리-최적화)
  - [4. 관계 DBMS의 시스템 카탈로그](#4-관계-dbms의-시스템-카탈로그)
  - [5. 시스템 카탈로그의 갱신](#5-시스템-카탈로그의-갱신)
  - [6. 시스템 카탈로그에 유지되는 통계 정보](#6-시스템-카탈로그에-유지되는-통계-정보)

<!-- Created by https://github.com/ekalinin/github-markdown-toc -->
<!-- Added by: sungminyou, at: 2022년 9월  1일 목요일 12시 22분 02초 KST -->

<!--te-->

## 1. 시스템 카탈로그

- 시스템 카탈로그는 데이터베이스의 객체(사용자, 릴레이션, 뷰, 인덱스, 권한 등)와 구조들에 관한 모든 데이터를 포함
- 시스템 카탈로그를 메타데이터라고 함, 메타데이터는 데이터에 관한 데이터라는 의미
- 시스템 카탈로그는 사용자 및 쿼리 최적화 모듈 등 DBMS 자신의 구성요소에 의해 사용됨
- 시스템 카탈로그는 관계 DBMS 마다 표준화되어 있지 않아서 관계 DBMS마다 서로 다른 형태로 시스템 카탈로그 기능을 제공함
- 시스템 카탈로그를 데이터 사전(data dictionary) 또는 시스템 테이블이라고도 부른다

## 2. 시스템 카탈로그가 쿼리 프로세싱에 어떻게 활용되는가

- 이 예시를 보고 어떤 과정이 일어나는지 보자

  ```sql
  SELECT EMPNAME, SALARY, SALARY * 1.1
  FROM EMPLOYEE
  WHERE TITLE = '과장' AND DNO = 2;
  ```

  - SELECT문이 문법적으로 정확한가를 검사
  - SELECT문에서 참조하는 EMPLOYEE 릴레이션이 데이터베이스에 존재하는가를 검사
  - EMPLOYEE 릴레이션에 SELECT절에 열거된 애트리뷰트들과 WHERE절에서 조건에 사용된 애트리뷰트들이 존재하는가를 검사
  - SALARY 애트리뷰트가 수식에 사용되었으므로 이 애트리뷰트의 데이터 타입이 숫자형인가를 검사하고, TITLE이 문자열과 비교되었으므로 이 애트리뷰트의 데이터 타입이 문자형인가 등을 검사함
  - 이 쿼리를 입력한 사용자가 EMPLOYEE 릴레이션의 ENPNAME, SALARY 애트리뷰트를 검색할 수 있는 권한이 있는가를 확인함
  - TITLE 애트리뷰트와 DNO 애트리뷰트에 인덱스가 정의되어 있는지 확인함
  - 두 애트리뷰트들에 각각 인덱스가 존재한다고 가정했을 때, DBMS가 두 인덱스 중에서 사용할 것을 선택할 때, 조건을 만족하는 튜플 수가 적은 것을 선택하기 위해서는 관계 데이터베이스 시스템에 데이터베이스 외에 추가로 정보를 유지해야 함
    - 한 릴레이션에 여러 개의 인덱스가 있을 땐, 무조건 하나만 쓸 수 있음
    - SELECT해보기 전까지는 어떤게 튜플 수가 적을 지 알 길이 없는데, 이전에 실행했던 모든 쿼리들에 대한 통계 데이터를 활용하는 방법을 생각해볼 수 있다(위에서 말한 추가로 유지하는 정보), 데이터가 동적으로 변하지만 참고 자료로 활용될 수는 있음
  - 한 릴레이션의 전체 튜플 수와 그 릴레이션에 정의된 각 인덱스에 존재하는 상이한 값들의 개수를 유지하면 어느 인덱스를 사용하는 것이 유리한가를 예상할 수 있음(통계 정보)

## 3. 쿼리 최적화

- DBMS가 쿼리를 수행하는 여러 가지 방법들 중에서 가장 비용이 적게 드는 방법을 찾는 과정
- 쿼리 최적화 모듈이 정확한 결정을 내릴 수 있도록 DBMS는 자체 목적을 위해서 시스템 카탈로그에 다양한 정보를 유지함
- 사용자가 쿼리 최적화 모듈을 깊게 이해할 필요는 없지만 쿼리 최적화 모듈이 정확한 수행 방법을 결정하기 위해서는 릴레이션에 관한 다양한 통계 정보가 정확하게 유지돼야 한다는 것을 알고 있어야한다

## 4. 관계 DBMS의 시스템 카탈로그

- 사용자 릴레이션과 마찬가지로 메타데이터도 릴레이션 형태로 저장되기 때문에 사용자 릴레이션에 적용되는 recovery 기법과 동시성 제어 기법을 동일하게 사용할 수 있음
- 시스템 카탈로그는 사용자 릴레이션처럼 SELECT문을 사용하여 내용을 검색할 수 있음
- 시스템 카탈로그에는 릴레이션, 애트리뷰트, 인덱스, 사용자, 권한 등 각 유형마다 별도의 릴레이션이 유지됨
- EMPLOYEE 릴레이션과 DEPARTMENT 릴레이션에 대해서 시스템 카탈로그에 어떤 정보들이 유지되는가를 이해하기 쉽도록 시스템 카탈로그를 매우 단순화하여 설명함
- 릴레이션에 관한 정보를 유지하는 릴레이션의 이름이 SYS_RELATION, 애트리뷰트들에 관한 정보를 유지하는 릴레이션의 이름이 SYS_ATTRIBUTE(MS SQL server 기준, DBMS마다 다름)

  ![1](https://user-images.githubusercontent.com/48282185/187824943-ca3108ca-a4c9-42eb-b09b-a44b94a95e59.png)

  - Postgresql에서도 \du를 통해서 사용자 테이블 조회하고, \dt를 통해서 릴레이션 테이블 조회하고 했던거 기억이 난다

## 5. 시스템 카탈로그의 갱신

- DBMS만 시스템 카탈로그 갱신이 가능하다
- 어떤 사용자도 시스템 카탈로그를 직접 갱신할 수 없음, 즉 DELETE, UPDATE, INSERT문을 사용해서 시스템 카탈로그를 변경할 수 없음, 권한이 있다면 SELECT로 검색은 가능
- EMPLOYEE 릴레이션의 소유자인 KIM이 EMPLOYEE 릴레이션에서 MANAGER 애트리뷰트를 삭제하는 상황을 가정해보자

  ```sql
  ALTER TABLE EMPLOYEE DROP COLUMN MANAGER;
  ```

  - 릴레이션에서 삭제하는 것은 가능하지만 아래와 같이 메타데이터에서 삭제하려고 하면 DBMS가 reject시킨다

  ```sql
  DELETE FROM SYS_ATTRIBUTE WHERE AttRelId = 'EMPLOYEE' AND AttName = 'MANAGER';
  ```

## 6. 시스템 카탈로그에 유지되는 통계 정보

- 릴레이션
  - 튜플의 크기, 튜플 수, 각 블록의 채우기 비율(filling factor), 블록킹 인수(blocking factor), 릴레이션의 크기(블록 수)
- 뷰
  - 뷰의 이름과 정의
- 애트리뷰트
  - 애트리뷰트의 타입과 크기, 애트리뷰트 내의 상이한 값들의 수(카디날리티), 애트리뷰트 값의 범위(도메인), 선택율(조건을 만족하는 튜플 수 / 전체 튜플수, 인덱스 선택에 적용될 수 있음)
- 사용자
  - 접근할 수 있는 릴레이션과 권한
- 인덱스
  - 인덱스된 애트리뷰트, (비)클러스터링 인덱스, 밀집 / 희소 인덱스 여부, 인덱스의 높이, 1단계 인덱스의 블록 수
- MS SQL Server의 시스템 카탈로그
  - 이런게 있고, 얘는 이렇게 관리하는구나 정도로 보고 넘어갈 것
  - 통계 정보는 기본적으로 주기적 자동 갱신하고, real-time이 아니라 곧바로 반영이 안될 수 있음, 근데 강제로 최신화 할 수는 있음(UDPATE STTISTICS 문)
  - 통계 정보를 갱신할 필요성이 있는가를 확인하기 위해서 샘플링 방법을 사용함(갱신할 것들이 어느 정도 쌓여서 batch로 갱신)
  - 통계 정보가 갱신되는 빈도는 애트리뷰트 또는 인덱스의 크기와 변경되는 데이터의 양에 따라 결정됨
  - 모든 릴레이션들에 대한 구성을 정의하는 데이터를 시스템 테이블이라고 부르는 특수한 테이블 집합에 저장함
  - 사용자나 응용 프로그램이 정보 스키마 뷰(INFORMATION_SCHEMA, 이거는 DBMS 표준이라 다른 MS SQL server 이외에 다른 DBMS에서도 이용가능, 검색해보니까 mysql, posgresql 다 있네), 뷰, transact-SQL 문 및 함수, 시스템 저장 프로시저 등을 사용해서 메타데이터를 검색함

> 출처
>
> - 이화여대 용환승 교수님 강의
> - 홍의경 저, MS SQL Server 기반 데이터베이스 배움터, 생능출판사, 2012년,
> - 이석호 저, 데이터베이스 시스템, 정익사, 2009.
> - A. Silberschatz, H. Korth, S. Sudarshan, "Database System Concepts," 6th Ed., McGraw-Hill, 2010.
> - Elmasri and Navathe, “ Fundamentals of Database Systems”, 6th ed. Addison-Wesley, 2010.
> - C.J.Date, “An Introduction to Database Systems (8th Edition)”, Addison-Wesley, 2003.
> - Won Kim, "Modern Database Systems," ACM Press, 1994
